<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>DoveListener 斑鸠监听面板</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f7fb;
        color: #333;
      }
      header {
        background: linear-gradient(135deg, #4f46e5, #22c55e);
        color: white;
        padding: 16px 24px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.25);
      }
      header h1 {
        margin: 0;
        font-size: 20px;
      }
      main {
        max-width: 960px;
        margin: 24px auto;
        padding: 0 16px 32px;
      }
      .card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(15, 23, 42, 0.08);
        padding: 16px 20px;
        margin-bottom: 16px;
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .card-title {
        font-size: 16px;
        font-weight: 600;
      }
      .stats-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .stat-item {
        flex: 1 1 120px;
        background: #f9fafb;
        border-radius: 8px;
        padding: 8px 10px;
      }
      .stat-label {
        font-size: 12px;
        color: #6b7280;
      }
      .stat-value {
        font-size: 16px;
        font-weight: 600;
        margin-top: 4px;
      }
      .muted {
        color: #6b7280;
        font-size: 12px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th,
      td {
        padding: 6px 8px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
      }
      th {
        background: #f9fafb;
        font-weight: 600;
      }
      tr:nth-child(even) {
        background: #f9fafb;
      }
      .date-picker {
        font-size: 13px;
        padding: 4px 6px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
      }
      .refresh-btn {
        padding: 4px 10px;
        font-size: 12px;
        border-radius: 999px;
        border: none;
        cursor: pointer;
        background: #4f46e5;
        color: #fff;
      }
      canvas {
        max-width: 100%;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header>
      <h1>DoveListener · 斑鸠叫声监听面板</h1>
      <div class="muted">实时监听 + 每日规律统计</div>
    </header>
    <main>
      <section class="card">
        <div class="card-header">
          <div class="card-title">今日概览</div>
          <div>
            <input id="dateInput" class="date-picker" type="date" />
            <button class="refresh-btn" onclick="loadAll()">刷新</button>
          </div>
        </div>
        <div class="stats-grid" id="statsGrid">
          <div class="stat-item">
            <div class="stat-label">总叫声次数</div>
            <div class="stat-value" id="totalCalls">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">最早叫声时间</div>
            <div class="stat-value" id="firstCall">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">最频繁时段</div>
            <div class="stat-value" id="peakRange">-</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">最频繁时段次数</div>
            <div class="stat-value" id="peakCount">-</div>
          </div>
        </div>
        <div class="muted" id="statsHint"></div>
      </section>

      <section class="card">
        <div class="card-header">
          <div class="card-title">时间分布（每 30 分钟）</div>
        </div>
        <canvas id="chartCanvas" height="120"></canvas>
      </section>

      <section class="card">
        <div class="card-header">
          <div class="card-title">事件列表（当日）</div>
        </div>
        <div style="max-height: 260px; overflow-y: auto">
          <table>
            <thead>
              <tr>
                <th>时间</th>
                <th>物种</th>
                <th>置信度</th>
                <th>音频</th>
              </tr>
            </thead>
            <tbody id="eventsTableBody"></tbody>
          </table>
        </div>
      </section>
    </main>
    <script>
      let chart;

      function formatTime(s) {
        if (!s) return "-";
        const d = new Date(s);
        if (Number.isNaN(d.getTime())) return "-";
        return (
          String(d.getHours()).padStart(2, "0") +
          ":" +
          String(d.getMinutes()).padStart(2, "0") +
          ":" +
          String(d.getSeconds()).padStart(2, "0")
        );
      }

      function formatRange(start, end) {
        if (!start || !end) return "-";
        return formatTime(start) + " ~ " + formatTime(end);
      }

      async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error("请求失败");
        return res.json();
      }

      async function loadStats(dateStr) {
        const url = dateStr ? `/api/stats/${dateStr}` : "/api/stats/today";
        const data = await fetchJSON(url);

        document.getElementById("totalCalls").innerText = data.total_calls;
        document.getElementById("firstCall").innerText = formatTime(
          data.first_call_time
        );
        document.getElementById("peakRange").innerText = formatRange(
          data.peak_start,
          data.peak_end
        );
        document.getElementById("peakCount").innerText = data.peak_count;

        if (data.total_calls === 0) {
          document.getElementById("statsHint").innerText = "该日尚无斑鸠叫声记录。";
        } else {
          document.getElementById("statsHint").innerText = "";
        }

        // 更新图表
        const labels = data.bins.map((b) => formatTime(b.start));
        const counts = data.bins.map((b) => b.count);
        if (chart) {
          chart.data.labels = labels;
          chart.data.datasets[0].data = counts;
          chart.update();
        } else {
          const ctx = document.getElementById("chartCanvas").getContext("2d");
          chart = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "叫声次数",
                  data: counts,
                  backgroundColor: "rgba(79, 70, 229, 0.7)",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0,
                  },
                },
              },
            },
          });
        }
      }

      async function loadEvents(dateStr) {
        const url = dateStr ? `/api/events?date_str=${dateStr}` : "/api/events";
        const u = dateStr ? `/api/events?date_str=${dateStr}` : "/api/events";
        const data = await fetchJSON(
          dateStr ? `/api/events?date_str=${dateStr}` : "/api/events"
        );

        const tbody = document.getElementById("eventsTableBody");
        tbody.innerHTML = "";
        data.forEach((e) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${formatTime(e.timestamp)}</td>
            <td>${e.species || "-"}</td>
            <td>${(e.confidence * 100).toFixed(0)}%</td>
            <td><span class="muted">${e.audio_path || ""}</span></td>
          `;
          tbody.appendChild(tr);
        });
      }

      async function loadAll() {
        const input = document.getElementById("dateInput");
        const dateStr = input.value || null;
        await Promise.all([loadStats(dateStr), loadEvents(dateStr)]);
      }

      (function init() {
        const input = document.getElementById("dateInput");
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        input.value = `${yyyy}-${mm}-${dd}`;
        loadAll();
        // 可选：每 60 秒自动刷新一次
        setInterval(loadAll, 60000);
      })();
    </script>
  </body>
  </html>




