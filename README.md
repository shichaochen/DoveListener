# DoveListener - ESP32 æ–‘é¸ å«å£°è¯†åˆ«ç³»ç»Ÿ

åŸºäº **ESP32 è¾¹ç¼˜è®¡ç®—** + **ESPHome/Home Assistant æœåŠ¡å™¨**çš„æ–‘é¸ å«å£°è‡ªåŠ¨è¯†åˆ«ä¸ç»Ÿè®¡ç³»ç»Ÿã€‚

## ğŸ¯ ç³»ç»Ÿç‰¹ç‚¹

- **è¾¹ç¼˜è®¡ç®—**ï¼šESP32 æœ¬åœ°å®æ—¶è¯†åˆ«æ–‘é¸ å«å£°ï¼Œæ— éœ€äº‘ç«¯æ¨ç†
- **ä½åŠŸè€—**ï¼šESP32 åŠŸè€—ä½ï¼Œé€‚åˆé•¿æœŸ 24/7 è¿è¡Œ
- **å®æ—¶å“åº”**ï¼šæœ¬åœ°è¯†åˆ«ï¼Œæ¯«ç§’çº§å“åº”
- **è‡ªåŠ¨ç»Ÿè®¡**ï¼šHome Assistant è‡ªåŠ¨è®°å½•ã€ç»Ÿè®¡å’Œç”ŸæˆæŠ¥å‘Š
- **å¤šç»´åº¦åˆ†æ**ï¼šæ¯æ—¥/æ¯å‘¨/æ¯æœˆè‡ªåŠ¨ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š

## ğŸ“‹ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ESP32 è¾¹ç¼˜è®¡ç®—è®¾å¤‡              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ I2S éº¦å…‹é£â”‚â†’ â”‚TensorFlowâ”‚â†’        â”‚
â”‚  â”‚ æŒç»­å½•éŸ³  â”‚  â”‚Lite æ¨¡å‹ â”‚         â”‚
â”‚  â”‚ (16kHz)  â”‚  â”‚å®æ—¶è¯†åˆ«   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                    â”‚                 â”‚
â”‚                    â–¼                 â”‚
â”‚           æ£€æµ‹åˆ°æ–‘é¸ å«å£°              â”‚
â”‚                    â”‚                 â”‚
â”‚                    â–¼                 â”‚
â”‚         WiFi å‘é€äº‹ä»¶åˆ°æœåŠ¡å™¨         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ HTTP POST
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Home Assistant (ESPHome) æœåŠ¡å™¨     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚Webhook   â”‚â†’ â”‚SQLite    â”‚â†’        â”‚
â”‚  â”‚æ¥æ”¶äº‹ä»¶  â”‚  â”‚å­˜å‚¨è®°å½•   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                    â”‚                 â”‚
â”‚                    â–¼                 â”‚
â”‚        è‡ªåŠ¨ç»Ÿè®¡ï¼ˆä»Šæ—¥/å‘¨/æœˆï¼‰          â”‚
â”‚                    â”‚                 â”‚
â”‚                    â–¼                 â”‚
â”‚      è‡ªåŠ¨ç”ŸæˆæŠ¥å‘Šï¼ˆæ¯æ—¥/å‘¨/æœˆï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¡¬ä»¶å‡†å¤‡

**å¿…éœ€ç¡¬ä»¶ï¼š**
- ESP32 å¼€å‘æ¿ï¼ˆæ¨è ESP32-WROOM-32 æˆ– ESP32-S3ï¼‰
- I2S æ•°å­—éº¦å…‹é£ï¼ˆæ¨è INMP441ï¼‰
- USB æ•°æ®çº¿ï¼ˆç”¨äºä¸Šä¼ ä»£ç å’Œä¾›ç”µï¼‰

**INMP441 è¿æ¥æ–¹å¼ï¼š**
```
INMP441    ->    ESP32
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
VDD        ->    3.3V
GND        ->    GND
WS (LRCLK) ->    GPIO 25
SCK (BCLK) ->    GPIO 33
SD (DOUT)  ->    GPIO 32
```

### 2. è®­ç»ƒæ¨¡å‹

#### 2.1 å‡†å¤‡æ•°æ®é›†

æ”¶é›†æ–‘é¸ å«å£°å’ŒèƒŒæ™¯å™ªå£°æ ·æœ¬ï¼Œæ•´ç†æˆä»¥ä¸‹ç»“æ„ï¼š
```
data/
  train/
    dove/          # æ–‘é¸ å«å£°æ ·æœ¬ï¼ˆå»ºè®® 100+ ä¸ªï¼‰
    background/     # èƒŒæ™¯å™ªå£°æ ·æœ¬ï¼ˆå»ºè®® 100+ ä¸ªï¼‰
  test/
    dove/
    background/
```

**æ•°æ®æ”¶é›†å»ºè®®ï¼š**
- ä» [Xeno-canto](https://www.xeno-canto.org/) ä¸‹è½½æ–‘é¸ å«å£°
- ä» [Macaulay Library](https://www.macaulaylibrary.org/) ä¸‹è½½
- è‡ªå·±å½•åˆ¶ï¼ˆä½¿ç”¨æ‰‹æœº/å½•éŸ³ç¬”ï¼‰

ä½¿ç”¨æ•°æ®é¢„å¤„ç†è„šæœ¬ï¼š
```bash
cd training
python3 collect_data.py --input_dir raw_audio/dove --output_dir data/train --category dove
python3 collect_data.py --input_dir raw_audio/background --output_dir data/train --category background
```

#### 2.2 è®­ç»ƒæ¨¡å‹

```bash
cd training
pip install -r requirements.txt
python3 train_model.py --train_dir data/train --epochs 50 --output_dir models
```

#### 2.3 è½¬æ¢ä¸º ESP32 æ ¼å¼

```bash
python3 convert_model_to_c_array.py models/dove_detector.tflite ../esp32/model.h
```

### 3. éƒ¨ç½² ESP32

#### 3.1 å®‰è£… Arduino IDE å’Œä¾èµ–

1. å®‰è£… [Arduino IDE](https://www.arduino.cc/en/software)
2. å®‰è£… ESP32 æ”¯æŒï¼š
   - æ–‡ä»¶ -> é¦–é€‰é¡¹ -> é™„åŠ å¼€å‘æ¿ç®¡ç†å™¨ç½‘å€ï¼š
     ```
     https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
     ```
   - å·¥å…· -> å¼€å‘æ¿ -> å¼€å‘æ¿ç®¡ç†å™¨ -> æœç´¢ "ESP32" -> å®‰è£…
3. å®‰è£…åº“ï¼š
   - `ArduinoJson` (by Benoit Blanchon)
   - `TensorFlowLite_ESP32`ï¼ˆå¦‚æœå¯ç”¨ï¼‰

#### 3.2 é…ç½®ä»£ç 

ç¼–è¾‘ `esp32/dove_detector.ino`ï¼Œä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼š

```cpp
const char* WIFI_SSID = "ä½ çš„WiFiåç§°";
const char* WIFI_PASSWORD = "ä½ çš„WiFiå¯†ç ";

// MQTT é…ç½®
const char* MQTT_BROKER = "192.168.1.100";  // MQTT Broker åœ°å€ï¼ˆé€šå¸¸æ˜¯ Home Assistant åœ°å€ï¼‰
const int MQTT_PORT = 1883;                 // MQTT ç«¯å£ï¼ˆé»˜è®¤ 1883ï¼ŒTLS ä½¿ç”¨ 8883ï¼‰
const char* MQTT_USERNAME = "";            // MQTT ç”¨æˆ·åï¼ˆå¦‚æœä¸éœ€è¦è®¤è¯ï¼Œç•™ç©ºï¼‰
const char* MQTT_PASSWORD = "";            // MQTT å¯†ç ï¼ˆå¦‚æœä¸éœ€è¦è®¤è¯ï¼Œç•™ç©ºï¼‰
const char* MQTT_CLIENT_ID = "esp32_dove_detector_01";  // å®¢æˆ·ç«¯ IDï¼ˆæ¯ä¸ªè®¾å¤‡å”¯ä¸€ï¼‰
const char* MQTT_TOPIC = "dove/detector/event";  // MQTT ä¸»é¢˜
```

**æ³¨æ„ï¼š** éœ€è¦å®‰è£… `PubSubClient` åº“ï¼š
- å·¥å…· -> ç®¡ç†åº“ -> æœç´¢ "PubSubClient" -> å®‰è£…

#### 3.3 ç¼–è¯‘å’Œä¸Šä¼ 

1. é€‰æ‹©å¼€å‘æ¿ï¼šå·¥å…· -> å¼€å‘æ¿ -> ESP32 Arduino -> ESP32 Dev Module
2. é€‰æ‹©ç«¯å£ï¼šå·¥å…· -> ç«¯å£ -> é€‰æ‹©ä½ çš„ ESP32
3. ç¼–è¯‘ï¼šé¡¹ç›® -> éªŒè¯/ç¼–è¯‘
4. ä¸Šä¼ ï¼šé¡¹ç›® -> ä¸Šä¼ 

### 4. é…ç½® Home Assistant

#### 4.1 å®‰è£… Home Assistant

å¦‚æœè¿˜æ²¡æœ‰å®‰è£…ï¼Œå‚è€ƒ [Home Assistant å®˜æ–¹æ–‡æ¡£](https://www.home-assistant.io/installation/)ã€‚

#### 4.2 é…ç½® MQTT Broker

Home Assistant é€šå¸¸è‡ªå¸¦ Mosquitto MQTT Brokerã€‚å¦‚æœæ²¡æœ‰ï¼š

1. åœ¨ Home Assistant ä¸­ï¼šè®¾ç½® -> åŠ è½½é¡¹ -> åŠ è½½é¡¹å•†åº—
2. æœç´¢ "Mosquitto broker" å¹¶å®‰è£…
3. å¯åŠ¨å¹¶é…ç½®ï¼ˆå¦‚æœéœ€è¦ç”¨æˆ·åå¯†ç ï¼‰

å¦‚æœä½¿ç”¨å¤–éƒ¨ MQTT Brokerï¼Œåœ¨ `configuration.yaml` ä¸­æ·»åŠ ï¼š

```yaml
mqtt:
  broker: 192.168.1.100
  port: 1883
  username: your_username  # å¯é€‰
  password: your_password   # å¯é€‰
```

#### 4.3 æ·»åŠ é…ç½®

å°†ä»¥ä¸‹æ–‡ä»¶å†…å®¹æ·»åŠ åˆ° Home Assistantï¼š

- `homeassistant/dove_listener.yaml` â†’ `configuration.yaml` æˆ–ä½œä¸ºåŒ…
- `homeassistant/automations.yaml` â†’ `automations.yaml`
- `homeassistant/shell_commands.yaml` â†’ `configuration.yaml` æˆ–ç‹¬ç«‹æ–‡ä»¶

#### 4.4 é…ç½®æŠ¥å‘Šç”Ÿæˆ

1. å°† `reports/generate_reports.py` å¤åˆ¶åˆ° Home Assistant çš„ `/config/dove_reports/` ç›®å½•
2. å®‰è£… Python ä¾èµ–ï¼š
   ```bash
   pip3 install pandas matplotlib
   ```
3. é‡å¯ Home Assistant

## ğŸ“ é¡¹ç›®ç»“æ„

```
DoveListener/
â”œâ”€â”€ README.md                    # æœ¬æ–‡ä»¶
â”œâ”€â”€ esp32/                       # ESP32 è®¾å¤‡ç«¯ä»£ç 
â”‚   â”œâ”€â”€ dove_detector.ino        # Arduino ä¸»ç¨‹åº
â”‚   â”œâ”€â”€ esphome_config.yaml      # ESPHome é…ç½®ï¼ˆå¯é€‰ï¼‰
â”‚   â”œâ”€â”€ model.h                  # TensorFlow Lite æ¨¡å‹ï¼ˆéœ€è®­ç»ƒç”Ÿæˆï¼‰
â”‚   â””â”€â”€ README.md                # ESP32 éƒ¨ç½²æŒ‡å—
â”œâ”€â”€ training/                     # æ¨¡å‹è®­ç»ƒç›¸å…³
â”‚   â”œâ”€â”€ train_model.py           # æ¨¡å‹è®­ç»ƒè„šæœ¬
â”‚   â”œâ”€â”€ collect_data.py          # æ•°æ®æ”¶é›†å’Œé¢„å¤„ç†
â”‚   â”œâ”€â”€ convert_model_to_c_array.py  # æ¨¡å‹è½¬ C æ•°ç»„
â”‚   â”œâ”€â”€ requirements.txt         # Python ä¾èµ–
â”‚   â””â”€â”€ README.md                # è®­ç»ƒæŒ‡å—
â”œâ”€â”€ homeassistant/               # Home Assistant é…ç½®
â”‚   â”œâ”€â”€ dove_listener.yaml       # ä¼ æ„Ÿå™¨å’Œè‡ªåŠ¨åŒ–é…ç½®
â”‚   â”œâ”€â”€ automations.yaml         # æŠ¥å‘Šç”Ÿæˆè‡ªåŠ¨åŒ–
â”‚   â”œâ”€â”€ shell_commands.yaml      # Shell å‘½ä»¤é…ç½®
â”‚   â””â”€â”€ webhook_handler.py       # Webhook å¤„ç†å™¨ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ reports/                      # æŠ¥å‘Šç”Ÿæˆè„šæœ¬
    â””â”€â”€ generate_reports.py      # æ¯æ—¥/å‘¨/æœˆæŠ¥å‘Šç”Ÿæˆ
```

## ğŸ“Š åŠŸèƒ½è¯´æ˜

### ESP32 ç«¯åŠŸèƒ½

- âœ… æŒç»­å½•éŸ³ï¼ˆ16kHz é‡‡æ ·ç‡ï¼‰
- âœ… å®æ—¶è¿è¡Œ TensorFlow Lite æ¨¡å‹
- âœ… æœ¬åœ°è¯†åˆ«æ–‘é¸ å«å£°
- âœ… WiFi å‘é€æ£€æµ‹äº‹ä»¶åˆ°æœåŠ¡å™¨
- âœ… ä½åŠŸè€—è¿è¡Œ

### Home Assistant ç«¯åŠŸèƒ½

- âœ… Webhook æ¥æ”¶ ESP32 äº‹ä»¶
- âœ… SQLite æ•°æ®åº“å­˜å‚¨å†å²è®°å½•
- âœ… è‡ªåŠ¨è®¡æ•°å™¨ï¼ˆä»Šæ—¥/æœ¬å‘¨/æœ¬æœˆï¼‰
- âœ… è‡ªåŠ¨åŒ–è§„åˆ™ï¼ˆé‡ç½®è®¡æ•°å™¨ã€ç”ŸæˆæŠ¥å‘Šï¼‰
- âœ… æ¯æ—¥/æ¯å‘¨/æ¯æœˆè‡ªåŠ¨ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š

### æŠ¥å‘Šå†…å®¹

**æ¯æ—¥æŠ¥å‘Šï¼š**
- æ€»å«å£°æ¬¡æ•°
- æœ€æ—©å«å£°æ—¶é—´
- æœ€é¢‘ç¹æ—¶æ®µ
- 24 å°æ—¶æ—¶é—´åˆ†å¸ƒå›¾

**æ¯å‘¨æŠ¥å‘Šï¼š**
- æ¯æ—¥è¶‹åŠ¿ç»Ÿè®¡
- å‘¨æ€»æ¬¡æ•°
- æ¯æ—¥åˆ†å¸ƒå›¾

**æ¯æœˆæŠ¥å‘Šï¼š**
- æ¯æ—¥è¶‹åŠ¿ç»Ÿè®¡
- å‘¨ç»Ÿè®¡æ±‡æ€»
- æœˆæ€»æ¬¡æ•°
- è¶‹åŠ¿åˆ†æå›¾

## ğŸ”§ é…ç½®è¯´æ˜

### ESP32 é…ç½®å‚æ•°

åœ¨ `esp32/dove_detector.ino` ä¸­å¯ä»¥è°ƒæ•´ï¼š

```cpp
const int SAMPLE_RATE = 16000;           // é‡‡æ ·ç‡
const int AUDIO_DURATION_MS = 1000;      // æ¯æ¬¡åˆ†ææ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
const float DETECTION_THRESHOLD = 0.7;    // æ£€æµ‹é˜ˆå€¼ï¼ˆ0-1ï¼‰
const unsigned long MIN_EVENT_INTERVAL_MS = 2000;  // æœ€å°äº‹ä»¶é—´éš”

// MQTT é…ç½®
const char* MQTT_BROKER = "192.168.1.100";  // MQTT Broker åœ°å€
const int MQTT_PORT = 1883;                 // MQTT ç«¯å£
const char* MQTT_TOPIC = "dove/detector/event";  // MQTT ä¸»é¢˜
```

### Home Assistant é…ç½®

åœ¨ `homeassistant/dove_listener.yaml` ä¸­å¯ä»¥è°ƒæ•´ï¼š

- æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼
- è®¡æ•°å™¨é‡ç½®æ—¶é—´
- æŠ¥å‘Šç”Ÿæˆæ—¶é—´

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **è¯†åˆ«å»¶è¿Ÿ**ï¼š< 2 ç§’ï¼ˆå½•éŸ³ + æ¨ç† + å‘é€ï¼‰
- **åŠŸè€—**ï¼š~100-200mA @ 3.3Vï¼ˆæŒç»­è¿è¡Œï¼‰
- **æ¨¡å‹å¤§å°**ï¼š< 100KBï¼ˆé‡åŒ–åï¼‰
- **è¯†åˆ«å‡†ç¡®ç‡**ï¼š> 85%ï¼ˆå–å†³äºè®­ç»ƒæ•°æ®è´¨é‡ï¼‰

## ğŸ› æ•…éšœæ’æŸ¥

### ESP32 æ— æ³•è¿æ¥ WiFi
- æ£€æŸ¥ SSID å’Œå¯†ç æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ WiFi ä¿¡å·å¼ºåº¦è¶³å¤Ÿ
- æŸ¥çœ‹ä¸²å£è¾“å‡ºé”™è¯¯ä¿¡æ¯

### æ¨¡å‹æ¨ç†å¤±è´¥
- æ£€æŸ¥æ¨¡å‹æ–‡ä»¶æ˜¯å¦æ­£ç¡®åµŒå…¥
- ç¡®è®¤ Tensor Arena å¤§å°è¶³å¤Ÿ
- æŸ¥çœ‹ä¸²å£è¾“å‡ºçš„æ¨¡å‹ä¿¡æ¯

### Home Assistant æ”¶ä¸åˆ°äº‹ä»¶
- æ£€æŸ¥ MQTT Broker æ˜¯å¦è¿è¡Œ
- ç¡®è®¤ MQTT è¿æ¥é…ç½®æ­£ç¡®ï¼ˆåœ°å€ã€ç«¯å£ã€ç”¨æˆ·åå¯†ç ï¼‰
- æ£€æŸ¥ MQTT ä¸»é¢˜æ˜¯å¦æ­£ç¡®ï¼š`dove/detector/event`
- åœ¨ Home Assistant ä¸­ï¼šå¼€å‘è€…å·¥å…· -> MQTT -> ç›‘å¬ä¸»é¢˜ `dove/detector/event` æµ‹è¯•
- æŸ¥çœ‹ Home Assistant æ—¥å¿—

### è¯†åˆ«å‡†ç¡®ç‡ä½
- å¢åŠ è®­ç»ƒæ•°æ®é‡
- è°ƒæ•´æ£€æµ‹é˜ˆå€¼ `DETECTION_THRESHOLD`
- æ£€æŸ¥éº¦å…‹é£ä½ç½®å’Œæ–¹å‘

## ğŸ”„ æ‰©å±•åŠŸèƒ½

- ğŸ”„ å¤šè®¾å¤‡éƒ¨ç½²ï¼ˆä¸åŒä½ç½®ï¼‰
- ğŸ”„ å®æ—¶é€šçŸ¥ï¼ˆæ‰‹æœºæ¨é€ï¼‰
- ğŸ”„ æ•°æ®å¯è§†åŒ–ï¼ˆGrafanaï¼‰
- ğŸ”„ äº‘ç«¯å¤‡ä»½
- ğŸ”„ å…¶ä»–é¸Ÿç±»è¯†åˆ«ï¼ˆæ‰©å±•æ¨¡å‹ï¼‰

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- **ESP32 éƒ¨ç½²æŒ‡å—**ï¼š`esp32/README.md`
- **æ¨¡å‹è®­ç»ƒæŒ‡å—**ï¼š`training/README.md`
- **Home Assistant é…ç½®**ï¼š`homeassistant/` ç›®å½•ä¸‹çš„æ–‡ä»¶

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä¸ºå¼€æºé¡¹ç›®ï¼Œå¯è‡ªç”±ä½¿ç”¨å’Œä¿®æ”¹ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

**å¼€å§‹ä½¿ç”¨ï¼š** æŒ‰ç…§ä¸Šé¢çš„"å¿«é€Ÿå¼€å§‹"æ­¥éª¤ï¼Œä»è®­ç»ƒæ¨¡å‹å¼€å§‹ï¼Œç„¶åéƒ¨ç½² ESP32 è®¾å¤‡ï¼Œæœ€åé…ç½® Home Assistant æœåŠ¡å™¨ã€‚

