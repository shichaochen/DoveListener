# Home Assistant é…ç½®ï¼šæ–‘é¸ è¯†åˆ«ç³»ç»Ÿ
# å°†æ­¤é…ç½®æ·»åŠ åˆ°ä½ çš„ configuration.yaml æˆ–ä½œä¸ºç‹¬ç«‹åŒ…

# ========== ä¼ æ„Ÿå™¨å®šä¹‰ ==========
# æ³¨æ„ï¼šWebhook æ•°æ®é€šè¿‡è‡ªåŠ¨åŒ–å¤„ç†ï¼Œä¸éœ€è¦å•ç‹¬çš„ä¼ æ„Ÿå™¨
# å¦‚æœéœ€è¦æŸ¥çœ‹æœ€åæ£€æµ‹çš„ç½®ä¿¡åº¦ï¼Œå¯ä»¥ä½¿ç”¨ input_number

# ========== è¾“å…¥è¾…åŠ© ==========
input_number:
  dove_detection_threshold:
    name: "æ–‘é¸ æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼"
    min: 0
    max: 1
    step: 0.01
    initial: 0.7
    unit_of_measurement: "æ¦‚ç‡"
    icon: mdi:chart-line

  last_dove_confidence:
    name: "æœ€åæ£€æµ‹ç½®ä¿¡åº¦"
    min: 0
    max: 1
    step: 0.01
    initial: 0
    unit_of_measurement: "æ¦‚ç‡"
    icon: mdi:percent

input_datetime:
  last_dove_detection:
    name: "æœ€åæ£€æµ‹æ—¶é—´"
    has_date: true
    has_time: true
    icon: mdi:clock-time-four

# ========== è®¡æ•°å™¨ ==========
counter:
  dove_count_today:
    name: "ä»Šæ—¥æ–‘é¸ å«å£°æ¬¡æ•°"
    initial: 0
    step: 1
    icon: mdi:bird

  dove_count_week:
    name: "æœ¬å‘¨æ–‘é¸ å«å£°æ¬¡æ•°"
    initial: 0
    step: 1

  dove_count_month:
    name: "æœ¬æœˆæ–‘é¸ å«å£°æ¬¡æ•°"
    initial: 0
    step: 1

# ========== å†å²è®°å½• ==========
# ç¡®ä¿è®¡æ•°å™¨å’Œå†å²æ•°æ®è¢«è®°å½•
recorder:
  include:
    entities:
      - counter.dove_count_today
      - counter.dove_count_week
      - counter.dove_count_month
      - input_number.last_dove_confidence
      - input_datetime.last_dove_detection

# ========== MQTT ä¼ æ„Ÿå™¨ ==========
# æ¥æ”¶ ESP32 é€šè¿‡ MQTT å‘é€çš„æ£€æµ‹äº‹ä»¶
mqtt:
  sensor:
    - name: "Dove Detection Event"
      state_topic: "dove/detector/event"
      value_template: "{{ value_json.confidence }}"
      unit_of_measurement: "æ¦‚ç‡"
      json_attributes_topic: "dove/detector/event"
      json_attributes_template: "{{ value_json | tojson }}"
      availability_topic: "dove/detector/status"
      payload_available: "online"
      payload_not_available: "offline"

# ========== è‡ªåŠ¨åŒ–ï¼šæ¥æ”¶ ESP32 äº‹ä»¶ ==========
automation:
  # æ¥æ”¶ ESP32 é€šè¿‡ MQTT å‘é€çš„æ£€æµ‹äº‹ä»¶
  - alias: "æ¥æ”¶æ–‘é¸ æ£€æµ‹äº‹ä»¶"
    id: receive_dove_detection
    trigger:
      - platform: mqtt
        topic: "dove/detector/event"
    condition:
      - condition: template
        value_template: "{{ trigger.payload_json.event_type == 'dove_detected' }}"
      - condition: template
        value_template: "{{ trigger.payload_json.confidence | float >= states('input_number.dove_detection_threshold') | float }}"
    action:
      # æ›´æ–°æœ€åæ£€æµ‹æ—¶é—´
      - service: input_datetime.set_datetime
        target:
          entity_id: input_datetime.last_dove_detection
        data:
          datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
      
      # æ›´æ–°æœ€åæ£€æµ‹ç½®ä¿¡åº¦
      - service: input_number.set_value
        target:
          entity_id: input_number.last_dove_confidence
        data:
          value: "{{ trigger.payload_json.confidence | float }}"
      
      # å¢åŠ è®¡æ•°å™¨
      - service: counter.increment
        target:
          entity_id: counter.dove_count_today
      
      # è®°å½•åˆ°æ—¥å¿—
      - service: system_log.write
        data:
          message: "ğŸ¦ æ£€æµ‹åˆ°æ–‘é¸ å«å£° - ç½®ä¿¡åº¦: {{ trigger.payload_json.confidence | float * 100 | round(1) }}%, è®¾å¤‡: {{ trigger.payload_json.device_id }}"
          level: info
      
      # å¯é€‰ï¼šå‘é€é€šçŸ¥ï¼ˆå–æ¶ˆæ³¨é‡Šå¹¶é…ç½®ä½ çš„é€šçŸ¥æœåŠ¡ï¼‰
      # - service: notify.mobile_app_your_phone
      #   data:
      #     title: "ğŸ¦ æ£€æµ‹åˆ°æ–‘é¸ å«å£°"
      #     message: "ç½®ä¿¡åº¦: {{ trigger.payload_json.confidence | float * 100 | round(1) }}%"
      #     data:
      #       actions:
      #         - action: "VIEW_REPORT"
      #           title: "æŸ¥çœ‹ç»Ÿè®¡"

  # æ¯æ—¥å‡Œæ™¨é‡ç½®è®¡æ•°å™¨
  - alias: "æ¯æ—¥é‡ç½®è®¡æ•°å™¨"
    id: reset_daily_counter
    trigger:
      - platform: time
        at: "00:00:00"
    action:
      - service: counter.reset
        target:
          entity_id: counter.dove_count_today
      
      # å°†ä»Šæ—¥è®¡æ•°ç´¯åŠ åˆ°å‘¨è®¡æ•°
      - service: counter.increment
        target:
          entity_id: counter.dove_count_week
        data:
          value: "{{ states('counter.dove_count_today') | int }}"

  # æ¯å‘¨ä¸€é‡ç½®å‘¨è®¡æ•°å™¨
  - alias: "æ¯å‘¨é‡ç½®è®¡æ•°å™¨"
    id: reset_weekly_counter
    trigger:
      - platform: time
        at: "00:00:00"
        day_of_week:
          - mon
    action:
      - service: counter.reset
        target:
          entity_id: counter.dove_count_week
      
      # å°†å‘¨è®¡æ•°ç´¯åŠ åˆ°æœˆè®¡æ•°
      - service: counter.increment
        target:
          entity_id: counter.dove_count_month
        data:
          value: "{{ states('counter.dove_count_week') | int }}"

  # æ¯æœˆ1å·é‡ç½®æœˆè®¡æ•°å™¨
  - alias: "æ¯æœˆé‡ç½®è®¡æ•°å™¨"
    id: reset_monthly_counter
    trigger:
      - platform: time
        at: "00:00:00"
        day_of_month: 1
    action:
      - service: counter.reset
        target:
          entity_id: counter.dove_count_month

# ========== MQTT é…ç½®è¯´æ˜ ==========
# 1. ç¡®ä¿ Home Assistant å·²å®‰è£…å¹¶é…ç½® MQTT Brokerï¼ˆMosquittoï¼‰
# 2. åœ¨ Home Assistant ä¸­ï¼šè®¾ç½® -> è®¾å¤‡ä¸æœåŠ¡ -> MQTT
# 3. å¦‚æœä½¿ç”¨å¤–éƒ¨ MQTT Brokerï¼Œåœ¨ configuration.yaml ä¸­æ·»åŠ ï¼š
#    mqtt:
#      broker: 192.168.1.100
#      port: 1883
#      username: your_username  # å¯é€‰
#      password: your_password   # å¯é€‰
# 4. ESP32 è®¾å¤‡å°†å‘å¸ƒåˆ°ä¸»é¢˜: dove/detector/event
# 5. è®¾å¤‡çŠ¶æ€ä¸»é¢˜: dove/detector/status

